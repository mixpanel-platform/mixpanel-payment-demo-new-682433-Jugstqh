<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
      h1{
        font-size: 23px;
        color: #545454;
        width:50%;
        float:left;
      }
      .durationSumDiv{
        font-size: 18px;
        display: inline-block;
        color: #545454;
        font-weight: bold;
      }
      .halfChart{
        width:50%;
        float:left;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
      
      <h1>1. Average Daily Users (per week)</h1><br clear="all" /><br clear="all" />
      <div id="graphOne"></div><br clear="all" />
      
      <br clear="all" /><hr /><br clear="all" /><br clear="all" />
      
    </div>
    
    <script>
      /* Run query upon doc load */
      $(document).ready(function(){
        runQuery();
      });
    
      /* Set some variables */
      var graphOne = $('#graphOne').MPChart({chartType: 'line'});
      var startDate = new Date('December 29, 2014');
      
      /* Helper function: Get object size */
      Object.size = function(obj) {
        var size = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
        }
        return size;
      };
      
      /* ** Main Mixpanel query function ** */
      var runQuery = function() {
        
        /* Graph 1: Average mobile daily users per week TODO: change event names*/
        // Query all unique users who viewed product in a week TODO: need to do this daily and sum for week
        var $iphoneViewProduct = MP.api.segment("Button Clicked", {
              from: startDate,
              to: moment(),
              unit: 'week',
              type: 'unique',
              'where': 'properties["$os"] == "iPhone OS"'
        });
        var $iphoneViewProductDay = MP.api.segment("Button Clicked", {
              from: startDate,
              to: moment(),
              unit: 'day',
              type: 'unique',
              'where': 'properties["$os"] == "iPhone OS"'
        });
        // Query all unique users who viewed listing 
        var $iphoneViewListingDay = MP.api.segment("Application Opened", {
          from: startDate,
          to: moment(),
          unit: 'day',
          type: 'unique',
          'where': 'properties["$os"] == "iPhone OS"'
        });
        /* Graph 1 build */
        $.when($iphoneViewProduct, $iphoneViewListingDay, $iphoneViewProductDay).done(function(iphoneViewProduct, iphoneViewListingDay, iphoneViewProductDay) {
          var graphObj = {};
          graphObj['Daily Average'] = {};
          var weekList = [];
          var dayList = [];
          for(week in iphoneViewProduct.values()['Button Clicked']){
            weekList.push(week);
          }
          for(day in iphoneViewProductDay.values()['Button Clicked']) {
            dayList.push(day);
          }
          weekList.sort();
          dayList.sort();
          //console.log(iphoneViewProductDay.values()['Button Clicked']);
          //console.log(iphoneViewListingDay.values()['Application Opened']);
          var c = 1;
          var weeklySum = 0;
          for(var i = 0; i < dayList.length; i++){
            // Last week to analyze 
            if(dayList[i] == weekList[c]){
              graphObj['Daily Average'][weekList[c-1]] = weeklySum/7;
              weeklySum = 0;
              c++;
            }
            else {
              weeklySum += iphoneViewProductDay.values()['Button Clicked'][dayList[i]] + iphoneViewListingDay.values()['Application Opened'][dayList[i]];
            }
          }
          graphOne.MPChart('setData', graphObj);
        });
        /* End of Graph 1 build */
        
      };
    /* End query */
    
    /**
    Function that builds a bar chart given event counts 
    - "events" is structured like - [{"Event Name":{"Event Date": numberofEventsOnDate}, ... }, ...]
    **/
    function buildChartFromArray(events, chartElement) {
      //console.log(events);
      var barChartParams = {};
      // For each event...
      for(var i = 0; i < events.length; i++){
        for(eventName in events[i]){
          barChartParams[eventName] = 0;
          for(date in events[i][eventName]){
            barChartParams[eventName] += events[i][eventName][date];
          }
        }
      }
      chartElement.MPChart('setData', barChartParams);
    }
    
    </script>
  </body>
</html>
